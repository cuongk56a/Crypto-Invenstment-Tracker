version: '3.8'

services:
  # MongoDB Databases
  mongodb-auth:
    image: mongo:7.0
    container_name: crypto-mongodb-auth
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: auth_db
    volumes:
      - mongodb-auth-data:/data/db
      - mongodb-auth-config:/data/configdb
    networks:
      - crypto-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb-content:
    image: mongo:7.0
    container_name: crypto-mongodb-content
    restart: unless-stopped
    ports:
      - "27018:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: content_db
    volumes:
      - mongodb-content-data:/data/db
      - mongodb-content-config:/data/configdb
    networks:
      - crypto-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb-logger:
    image: mongo:7.0
    container_name: crypto-mongodb-logger
    restart: unless-stopped
    ports:
      - "27019:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: logger_db
    volumes:
      - mongodb-logger-data:/data/db
      - mongodb-logger-config:/data/configdb
    networks:
      - crypto-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Databases
  postgresql-auth:
    image: postgres:15-alpine
    container_name: crypto-postgresql-auth
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
      POSTGRES_DB: auth_db
    volumes:
      - postgresql-auth-data:/var/lib/postgresql/data
    networks:
      - crypto-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgresql-content:
    image: postgres:15-alpine
    container_name: crypto-postgresql-content
    restart: unless-stopped
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
      POSTGRES_DB: content_db
    volumes:
      - postgresql-content-data:/var/lib/postgresql/data
    networks:
      - crypto-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d content_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgresql-logger:
    image: postgres:15-alpine
    container_name: crypto-postgresql-logger
    restart: unless-stopped
    ports:
      - "5434:5432"
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
      POSTGRES_DB: logger_db
    volumes:
      - postgresql-logger-data:/var/lib/postgresql/data
    networks:
      - crypto-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d logger_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Message Broker (RabbitMQ)
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: crypto-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - crypto-network
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis (for caching/sessions if needed)
  redis:
    image: redis:7-alpine
    container_name: crypto-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --requirepass redis123
    volumes:
      - redis-data:/data
    networks:
      - crypto-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # API Gateway Service
  gateway:
    build:
      context: .
      dockerfile: apps/gateway/Dockerfile
    container_name: crypto-gateway
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      PORT: 3000
      MONGODB_AUTH_URI: mongodb://admin:admin123@mongodb-auth:27017/auth_db?authSource=admin
      MONGODB_CONTENT_URI: mongodb://admin:admin123@mongodb-content:27017/content_db?authSource=admin
      MONGODB_LOGGER_URI: mongodb://admin:admin123@mongodb-logger:27017/logger_db?authSource=admin
      POSTGRESQL_AUTH_URI: postgresql://admin:admin123@postgresql-auth:5432/auth_db
      POSTGRESQL_CONTENT_URI: postgresql://admin:admin123@postgresql-content:5432/content_db
      POSTGRESQL_LOGGER_URI: postgresql://admin:admin123@postgresql-logger:5432/logger_db
      RABBITMQ_URI: amqp://admin:admin123@rabbitmq:5672
      REDIS_URI: redis://:redis123@redis:6379
      AUTH_SERVICE_URL: http://auth:3001
      PORTFOLIO_SERVICE_URL: http://portfolio-service:3002
    depends_on:
      mongodb-auth:
        condition: service_healthy
      mongodb-content:
        condition: service_healthy
      mongodb-logger:
        condition: service_healthy
      postgresql-auth:
        condition: service_healthy
      postgresql-content:
        condition: service_healthy
      postgresql-logger:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - crypto-network

  # Auth Service
  auth:
    build:
      context: .
      dockerfile: apps/auth/Dockerfile
    container_name: crypto-auth
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: development
      PORT: 3001
      MONGODB_AUTH_URI: mongodb://admin:admin123@mongodb-auth:27017/auth_db?authSource=admin
      POSTGRESQL_AUTH_URI: postgresql://admin:admin123@postgresql-auth:5432/auth_db
      RABBITMQ_URI: amqp://admin:admin123@rabbitmq:5672
      REDIS_URI: redis://:redis123@redis:6379
      JWT_SECRET: your-jwt-secret-key-change-in-production
    depends_on:
      mongodb-auth:
        condition: service_healthy
      postgresql-auth:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - crypto-network

  # Portfolio Service
  portfolio-service:
    build:
      context: .
      dockerfile: apps/portfolio-service/Dockerfile
    container_name: crypto-portfolio-service
    restart: unless-stopped
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: development
      PORT: 3002
      MONGODB_CONTENT_URI: mongodb://admin:admin123@mongodb-content:27017/content_db?authSource=admin
      MONGODB_LOGGER_URI: mongodb://admin:admin123@mongodb-logger:27017/logger_db?authSource=admin
      POSTGRESQL_CONTENT_URI: postgresql://admin:admin123@postgresql-content:5432/content_db
      POSTGRESQL_LOGGER_URI: postgresql://admin:admin123@postgresql-logger:5432/logger_db
      RABBITMQ_URI: amqp://admin:admin123@rabbitmq:5672
      REDIS_URI: redis://:redis123@redis:6379
    depends_on:
      mongodb-content:
        condition: service_healthy
      mongodb-logger:
        condition: service_healthy
      postgresql-content:
        condition: service_healthy
      postgresql-logger:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - crypto-network

  # Web Frontend
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: crypto-web
    restart: unless-stopped
    ports:
      - "3003:3000"
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:3000
      NEXT_PUBLIC_GATEWAY_URL: http://gateway:3000
    depends_on:
      - gateway
    networks:
      - crypto-network

volumes:
  mongodb-auth-data:
  mongodb-auth-config:
  mongodb-content-data:
  mongodb-content-config:
  mongodb-logger-data:
  mongodb-logger-config:
  postgresql-auth-data:
  postgresql-content-data:
  postgresql-logger-data:
  rabbitmq-data:
  redis-data:

networks:
  crypto-network:
    driver: bridge
